on:
  workflow_call:
    secrets:
      AWS_DEV_ACCOUNT_ID:
        required: true
      AWS_QA_ACCOUNT_ID:
        required: true
      AWS_PROD_ACCOUNT_ID:
        required: true
      AWS_PIPELINE_ACCESS_KEY_ID:
        required: true
      AWS_PIPELINE_SECRET_ACCESS_KEY:
        required: true
      PACKAGE_USERNAME:
        required: true
      PACKAGE_TOKEN:
        required: true
      NEW_RELIC_ACCOUNT_ID:
        required: true
      NEW_RELIC_INGEST_KEY_LAMBDA:
        required: true

env:
  BUILD_SHA: ${{ github.sha }}
  ACTIONS_ALLOW_UNSECURE_COMMANDS: true
  AWS_REGION: us-east-1
  ROLE_DURATION_SECONDS: 3600
  AWS_DEFAULT_OUTPUT: json
  AWS_DEPLOYMENT_ROLE: pipeline
  ORGANIZATION: lineup
  GITHUB_USERNAME: ${{ secrets.PACKAGE_USERNAME }}
  GITHUB_TOKEN: ${{ secrets.PACKAGE_TOKEN }}
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_PIPELINE_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_PIPELINE_SECRET_ACCESS_KEY }}
  NEW_RELIC_ACCOUNT_ID: ${{ secrets.NEW_RELIC_ACCOUNT_ID }}
  NEW_RELIC_INGEST_KEY_LAMBDA: ${{ secrets.NEW_RELIC_INGEST_KEY_LAMBDA }}
  LAMBDA_RUNTIME: nodejs20.x
  LAMBDA_HANDLER: index.handler
  LAMBDA_TIMEOUT: "5"
  LAMBDA_MEMORY_SIZE: "128"
  LAMBDA_VIEWER_REQUEST_NAME: lineup-queueit-viewer-request
  LAMBDA_VIEWER_RESPONSE_NAME: lineup-queueit-viewer-response

  # Publicar versi√≥n al final (recomendado para Lambda@Edge)
  PUBLISH_VERSION: "true"


jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x]
    steps:
    - name: Set DEV environment variables
      if: github.ref == 'refs/heads/dev'
      run: |
        echo "::set-env name=STAGE::dev"
        echo "::set-env name=AWS_ACCOUNT_ID::${{ secrets.AWS_DEV_ACCOUNT_ID }}"
        echo "::set-env name=LAMBDA_ROLE_ARNE::arn:aws:iam::${{ secrets.AWS_PROD_ACCOUNT_ID }}:role/lineup-lambda-queueit"
    - name: Set QA environment variables
      if: github.ref == 'refs/heads/qa'
      run: |
        echo "::set-env name=STAGE::qa"
        echo "::set-env name=AWS_ACCOUNT_ID::${{ secrets.AWS_QA_ACCOUNT_ID }}"
        echo "::set-env name=LAMBDA_ROLE_ARNE::arn:aws:iam::${{ secrets.AWS_PROD_ACCOUNT_ID }}:role/lineup-lambda-queueit"
    - name: Set PROD environment variables
      if: github.ref == 'refs/heads/prod'
      run: |
        echo "::set-env name=STAGE::prod"
        echo "::set-env name=AWS_ACCOUNT_ID::${{ secrets.AWS_PROD_ACCOUNT_ID }}"
        echo "::set-env name=LAMBDA_ROLE_ARNE::arn:aws:iam::${{ secrets.AWS_PROD_ACCOUNT_ID }}:role/lineup-lambda-queueit"
    - name: üîë Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        role-to-assume: ${{ format('arn:aws:iam::{0}:role/{1}', env.AWS_ACCOUNT_ID,env.AWS_DEPLOYMENT_ROLE) }}
        role-duration-seconds: ${{ env.ROLE_DURATION_SECONDS }}
    - name: Checkout
      uses: actions/checkout@v4
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm ci

    - name: Build Queue-it artifacts
      run: npm run buildArtifacts

    - name: Validate generated ZIPs
      run: |
        set -euo pipefail
        ls -lah dist
        test -f dist/ViewerRequest.zip
        test -f dist/ViewerResponse.zip

    - name: Upsert ViewerRequest Lambda
      shell: bash
      run: |
        set -euo pipefail

        FUNCTION_NAME="${LAMBDA_VIEWER_REQUEST_NAME}-${STAGE}"
        ZIP_FILE="dist/ViewerRequest.zip"

        upsert_lambda() {
          local fn_name="$1"
          local zip_file="$2"

          echo "==> Procesando Lambda: ${fn_name}"
          echo "==> ZIP: ${zip_file}"

          if [[ ! -f "${zip_file}" ]]; then
            echo "ERROR: No existe ${zip_file}"
            exit 1
          fi

          if aws lambda get-function \
            --region "${AWS_REGION}" \
            --function-name "${fn_name}" >/dev/null 2>&1; then

            echo "La funci√≥n existe, actualizando c√≥digo..."
            aws lambda update-function-code \
              --region "${AWS_REGION}" \
              --function-name "${fn_name}" \
              --zip-file "fileb://${zip_file}" >/dev/null

            echo "‚úÖ C√≥digo actualizado: ${fn_name}"
          else
            echo "La funci√≥n no existe, creando..."
            aws lambda create-function \
              --region "${AWS_REGION}" \
              --function-name "${fn_name}" \
              --runtime "${LAMBDA_RUNTIME}" \
              --role "${LAMBDA_ROLE_ARN}" \
              --handler "${LAMBDA_HANDLER}" \
              --timeout "${LAMBDA_TIMEOUT}" \
              --memory-size "${LAMBDA_MEMORY_SIZE}" \
              --zip-file "fileb://${zip_file}" >/dev/null

            echo "‚úÖ Funci√≥n creada: ${fn_name}"
          fi

          if [[ "${PUBLISH_VERSION}" == "true" ]]; then
            echo "Publicando versi√≥n..."
            aws lambda publish-version \
              --region "${AWS_REGION}" \
              --function-name "${fn_name}" \
              --description "GitHub Actions ${GITHUB_SHA}" >/dev/null

            echo "‚úÖ Versi√≥n publicada para ${fn_name}"
          fi
        }

        upsert_lambda "${FUNCTION_NAME}" "${ZIP_FILE}"

    - name: Upsert ViewerResponse Lambda
      shell: bash
      run: |
        set -euo pipefail

        FUNCTION_NAME="${LAMBDA_VIEWER_RESPONSE_NAME}-${STAGE}"
        ZIP_FILE="dist/ViewerResponse.zip"

        upsert_lambda() {
          local fn_name="$1"
          local zip_file="$2"

          echo "==> Procesando Lambda: ${fn_name}"
          echo "==> ZIP: ${zip_file}"

          if [[ ! -f "${zip_file}" ]]; then
            echo "ERROR: No existe ${zip_file}"
            exit 1
          fi

          if aws lambda get-function \
            --region "${AWS_REGION}" \
            --function-name "${fn_name}" >/dev/null 2>&1; then

            echo "La funci√≥n existe, actualizando c√≥digo..."
            aws lambda update-function-code \
              --region "${AWS_REGION}" \
              --function-name "${fn_name}" \
              --zip-file "fileb://${zip_file}" >/dev/null

            echo "‚úÖ C√≥digo actualizado: ${fn_name}"
          else
            echo "La funci√≥n no existe, creando..."
            aws lambda create-function \
              --region "${AWS_REGION}" \
              --function-name "${fn_name}" \
              --runtime "${LAMBDA_RUNTIME}" \
              --role "${LAMBDA_ROLE_ARN}" \
              --handler "${LAMBDA_HANDLER}" \
              --timeout "${LAMBDA_TIMEOUT}" \
              --memory-size "${LAMBDA_MEMORY_SIZE}" \
              --zip-file "fileb://${zip_file}" >/dev/null

            echo "‚úÖ Funci√≥n creada: ${fn_name}"
          fi

          if [[ "${PUBLISH_VERSION}" == "true" ]]; then
            echo "Publicando versi√≥n..."
            aws lambda publish-version \
              --region "${AWS_REGION}" \
              --function-name "${fn_name}" \
              --description "GitHub Actions ${GITHUB_SHA}" >/dev/null

            echo "‚úÖ Versi√≥n publicada para ${fn_name}"
          fi
        }

        upsert_lambda "${FUNCTION_NAME}" "${ZIP_FILE}"

    # Opcional: tambi√©n subir artifacts (por si los quieres descargar)
    - name: Upload ViewerRequest artifact
      uses: actions/upload-artifact@v4
      with:
        name: ViewerRequest-zip
        path: dist/ViewerRequest.zip
        retention-days: 3

    - name: Upload ViewerResponse artifact
      uses: actions/upload-artifact@v4
      with:
        name: ViewerResponse-zip
        path: dist/ViewerResponse.zip
        retention-days: 3
